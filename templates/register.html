<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register Face</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-size: 1.2rem; padding: 1rem; font-family: sans-serif; }
        input, button { font-size: 1.2rem; margin-top: 1rem; display: block; width: 100%; padding: 0.5rem; }
    </style>
</head>
<body>
    <h2>Register Your Face</h2>
    <input type="text" id="username" placeholder="Enter username">
    <button type="button" id="registerBtn">Register Face</button>

    <script>
        document.getElementById("registerBtn").addEventListener("click", async () => {
            const username = document.getElementById("username").value.trim();
            if (!username) return alert("Please enter a username");

            // Step 1: Begin registration
            const beginRes = await fetch("/register", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ username })
            });

            const options = await beginRes.arrayBuffer();
            const publicKey = window.cbor.decode(options);

            // Step 2: Create credential
            const cred = await navigator.credentials.create({ publicKey });

            // Step 3: Complete registration
            const completeRes = await fetch("/register/complete", {
                method: "POST",
                body: window.cbor.encode(cred)
            });

            const completeData = await completeRes.arrayBuffer();
            const result = window.cbor.decode(completeData);

            if (result.status === "ok") {
                alert("Registration successful!");
                window.location.href = "/";
            } else {
                alert("Registration failed.");
            }
        });

        // Load CBOR library
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/cbor-js@0.1.0/cbor.min.js";
        document.head.appendChild(script);
    </script>
</body>
</html>
